import unittest
import mock

import os
import xml.etree.ElementTree as ET

import requests

from vmbot.helpers.files import CACHE_DB
from vmbot.helpers.exceptions import APIError

from vmbot.helpers import api


class TestAPI(unittest.TestCase):
    @classmethod
    def setUpClass(cls):
        # Delete cache.db before testing
        try:
            os.remove(CACHE_DB)
        except:
            pass

    def test_getTypeName(self):
        # typeID: 34 Tritanium
        self.assertEqual(api.getTypeName(34), "Tritanium")

    def test_getTypeName_invaliditem(self):
        self.assertEqual(api.getTypeName(-1), "{Failed to load}")

    def test_getSolarSystemData(self):
        # solarSystemID: 30000142 Jita
        self.assertDictEqual(
            api.getSolarSystemData(30000142),
            {'solarSystemID': 30000142, 'solarSystemName': "Jita",
             'constellationID': 20000020, 'constellationName': "Kimotoro",
             'regionID': 10000002, 'regionName': "The Forge"}
        )

    def test_getSolarSystemData_invalidsystem(self):
        self.assertDictEqual(
            api.getSolarSystemData(-1),
            {'solarSystemID': 0, 'solarSystemName': "{Failed to load}",
             'constellationID': 0, 'constellationName': "{Failed to load}",
             'regionID': 0, 'regionName': "{Failed to load}"}
        )

    def test_getTickers(self):
        # corporationID: 1164409536 [OTHER]
        # allianceID: 159826257 <OTHER>
        self.assertTupleEqual(api.getTickers(1164409536, 159826257), ("OTHER", "OTHER"))

    def test_getTickers_corponly(self):
        # corporationID: 1164409536 [OTHER] (member of <OTHER>)
        self.assertTupleEqual(api.getTickers(1164409536, None), ("OTHER", "OTHER"))

    def test_getTickers_allianceonly(self):
        # allianceID: 159826257 <OTHER>
        self.assertTupleEqual(api.getTickers(None, 159826257), (None, "OTHER"))

    def test_getTickers_invalidid(self):
        self.assertTupleEqual(api.getTickers(-1, -1), ("{Failed to load}", "{Failed to load}"))

    def test_getTickers_noids(self):
        self.assertTupleEqual(api.getTickers(None, None), (None, None))

    def test_getCRESTEndpoint(self):
        testURL = "https://crest-tq.eveonline.com/"

        requestsPatcher = mock.patch("requests.get")

        # Returns requests.Response without Cache-Control header
        def del_cache(*args, **kwargs):
            requestsPatcher.stop()
            r = requests.get(*args, **kwargs)
            mockRequests = requestsPatcher.start()
            mockRequests.side_effect = del_cache

            if "Cache-Control" in r.headers:
                del r.headers['Cache-Control']
            return r

        mockRequests = requestsPatcher.start()
        mockRequests.side_effect = del_cache

        # Test without cache
        res_nocache = api.getCRESTEndpoint(testURL)
        self.assertIsInstance(res_nocache, dict)
        requestsPatcher.stop()

        # Test with cache
        res_cache = api.getCRESTEndpoint(testURL)
        self.assertIsInstance(res_cache, dict)
        # Test cached response
        self.assertDictEqual(api.getCRESTEndpoint(testURL), res_cache)

    @mock.patch("requests.get", side_effect=requests.exceptions.RequestException("TestException"))
    def test_getCRESTEndpoint_RequestException(self, mockRequests):
        self.assertRaisesRegexp(APIError, "Error while connecting to CREST: TestException",
                                api.getCRESTEndpoint, "TestURL")

    def test_getCRESTEndpoint_flawedResponse(self):
        def flawed_response(*args, **kwargs):
            class Object(object):
                pass

            obj = Object()
            obj.text = "This is not a valid HTML document"
            obj.status_code = 404
            return obj

        # Returns non-200 status
        requestsPatcher = mock.patch("requests.get", side_effect=flawed_response)
        mockRequests = requestsPatcher.start()

        self.assertRaisesRegexp(APIError, "CREST returned error code 404",
                                api.getCRESTEndpoint, "TestURL")

        requestsPatcher.stop()

    def test_postXMLEndpoint(self):
        testURL = "https://api.eveonline.com/server/ServerStatus.xml.aspx"

        res_cache = api.postXMLEndpoint(testURL)
        self.assertIsInstance(res_cache, ET.Element)
        # Test cached response
        self.assertEqual(ET.tostring(api.postXMLEndpoint(testURL)), ET.tostring(res_cache))

    @mock.patch("requests.post", side_effect=requests.exceptions.RequestException("TestException"))
    def test_postXMLEndpoint_RequestException(self, mockRequests):
        self.assertRaisesRegexp(APIError, "Error while connecting to XML-API: TestException",
                                api.postXMLEndpoint, "TestURL")

    def test_postXMLEndpoint_flawedResponse(self):
        def flawed_response(*args, **kwargs):
            class Object(object):
                pass

            obj = Object()
            obj.text = "This is not a valid HTML document"
            obj.status_code = 404
            return obj

        # Returns non-200 status
        requestsPatcher = mock.patch("requests.post", side_effect=flawed_response)
        mockRequests = requestsPatcher.start()

        self.assertRaisesRegexp(APIError, "XML-API returned error code 404",
                                api.postXMLEndpoint, "TestURL")

        requestsPatcher.stop()


if __name__ == "__main__":
    unittest.main()
